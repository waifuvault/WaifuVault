services:
  redis:
    image: redis:latest
    container_name: redis
    restart: always
    command: [ "redis-server", "--maxmemory", "1gb", "--maxmemory-policy", "allkeys-lru" ]
    ports:
      - "127.0.0.1:6379:6379"

  postgres:
    image: postgres:latest
    container_name: postgres
    restart: always
    env_file:
      - postgres.env
    volumes:
      - postgres_data:/var/lib/postgresql
    ports:
      - "127.0.0.1:5004:5432"

  clamav:
    image: clamav/clamav-debian:stable
    container_name: clamav
    restart: always
    volumes:
      - ./files:/home/node/app/files:ro
      - clamav_data:/var/lib/clamav

  waifuvault:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: waifuvault
    restart: always
    depends_on:
      redis:
        condition: service_started
      postgres:
        condition: service_started
      thumbnails:
        condition: service_healthy
      clamav:
        condition: service_started
    ports:
      - "127.0.0.1:${PORT:-8081}:${PORT:-8081}"
    volumes:
      - ./files:/home/node/app/files
      - ./main.sqlite:/home/node/app/main.sqlite
      - ./postgres.env:/home/node/app/postgres.env:ro
    env_file:
      - .env.docker
      - postgres.env
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432

  frontend:
    build:
      context: .
      dockerfile: ./frontend/waifu-vault/Dockerfile
    container_name: waifu-vault-frontend
    restart: always
    depends_on:
      - waifuvault
    ports:
      - "127.0.0.1:3131:3000"
    env_file:
      - ./frontend/waifu-vault/.env

  zipfiles:
    build:
      context: .
      dockerfile: ./go/zipFiles/Dockerfile
    container_name: zipfiles
    restart: always
    depends_on:
      - redis
      - postgres
    ports:
      - "127.0.0.1:5005:8080"
    volumes:
      - ./files:/app/files
    env_file:
      - .env.docker
      - postgres.env

  thumbnails:
    build:
      context: .
      dockerfile: ./go/thumbnails/Dockerfile
    container_name: thumbnails
    restart: always
    depends_on:
      - redis
      - postgres
    ports:
      - "127.0.0.1:5006:8080"
    volumes:
      - ./files:/app/files
      - ./main.sqlite:/app/main.sqlite
    env_file:
      - .env.docker
      - postgres.env
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://127.0.0.1:8080/api/v1/health" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

volumes:
  postgres_data:
  clamav_data:
